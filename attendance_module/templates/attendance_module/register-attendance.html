{% extends 'nexus/layout.html' %}
{% load static %}
{% block title %}
Register Attendance
{% endblock title %}
{% load fullcalendar_tags %}
{% load table_tags %}
{% block breadcrumbs %}
    <span class="kt-subheader__separator kt-hidden"></span>
    <div class="kt-subheader__breadcrumbs">
        <a href="{% url 'dashboard' %}" class="kt-subheader__breadcrumbs-home"><i class="flaticon2-shelter"></i></a>
        <span class="kt-subheader__breadcrumbs-separator"></span>
        <a href="" class="kt-subheader__breadcrumbs-link">
            Attendances </a>
        <span class="kt-subheader__breadcrumbs-separator"></span>
        <a href="" class="kt-subheader__breadcrumbs-link">
            Register Attendances </a>
    </div>
{% endblock breadcrumbs %}
{% block content %}
<script>
    var globalGuard;
    $(function() {
        var csrftoken = Cookies.get('csrftoken');
        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        function set_fulfilled_icon(status) {
            var icon = $('#fulfilled-icon')
            if (status == 'red') {
                icon.text('cancel')
                icon.css('color', 'red')

            } else {
                icon.text('check_circle')
                icon.css('color', 'green')
            }
        };

        function set_text(status) {
            var item = $('#shift-verify')
            var icon = $('#verified-icon')
            if (status == 'U') {
                item.removeClass('btn-danger')
                item.text('Verify')
                item.addClass('btn-success')
                icon.text('cancel')
                icon.css('color', 'red')
            } else {
                item.removeClass('btn-success')
                item.text('Unverify')
                item.addClass('btn-danger')
                icon.text('check_circle')
                icon.css('color', 'green')
            }
        }

        function populate_view(response) {
            $('#clocked-start').text(response.start);
            $('#clocked-end').text(response.end);
            $('#clocked-duration').text(response.duration + " hrs");
            $('#clocked-duration').css('color', response.d_col);
            set_text(response.status)
            set_fulfilled_icon(response.d_col)
        }
        
        var calopt = {
            header: {
                left: 'today',
                center: 'title',
                right: 'month, agendaWeek'
            },
            plugins: [ 'interaction' ],
            selectable: true,
            eventClick: function(info) {
                $(document).off('click', '#shift-verify');
                $('#shift-details').show()
                $('#salary-footer').show()
                var hours_worked = (info.end - info.start) / 3600000;
                start = info.start.format()
                verify_btn = $.ajax({
                    type: 'GET',
                    url: "{% url 'attd-get-details' %}",
                    data: {'date':start, 'g_id':guard_id},
                    beforeSend: function() {
                        if (verify_btn != null) {
                            verify_btn.abort()
                        }
                    },
                    success: function(response) {
                        $('#shift-date').text(info.start.format("dddd, MMMM D, Y"));
                        populate_view(response    ) 
                        $(document).on('click', '#shift-verify',function() {
                            console.log("clicked verify")                                            
                            req = $.ajax({
                                url: "{% url 'attd-verify' %}",
                                data: {'date':start, 'g_id':guard_id},
                                success: function(response) {
                                    console.log(response.status)
                                    
                                    set_text(response.status)
                                    $.ajax({
                                        url: "{% url 'attd-get-shift' %}",
                                        data: {'p_id': guard_id},
                                        success: function(response) {
                                            fetch_events(response)
                                            //set_verified_icon(response.status)
                                        }
                                    });
                                }
                            });
                        });
                    }
                });
            },
            dayClick: function(date, jsEvent, view) {
                $('#calendar').fullCalendar('gotoDate',date);
                $('#calendar').fullCalendar('changeView','agendaWeek');
            }
        };
        $('#calendar').fullCalendar(calopt)

        function fetch_events(response) {
            console.log("fetching...")
            $('#guard-id__placeholder').text("ID#: " + response.g_id);
            $('#guard-name__placeholder').text(response.name);
            $('#guard-location').text(response.location);
            $('#guard-pic').attr('src', response.pic_url);

            $('#salary-amount').text("RM" + response.sum_pay);
            $('#v_pay').text("RM " + response.v_pay);
            $('#u_pay').text("RM " + response.u_pay);

            $('#calendar').fullCalendar('removeEvents');
            $('#calendar').fullCalendar('addEventSource', response.u_data);
            $('#calendar').fullCalendar('addEventSource', response.v_data);
            $('#calendar').fullCalendar('refetchEvents');
            $('#month-salary').text(response.sum_pay);
        }

        function show_hidden_div() {
            $('#calendar-area').show()
            $('#guard-details').show()
            $('#review-area').show()
        }
        var guard_id = 0;
        function row_clickable() {
            $(document).on('click', '#DataTables_Table_0 tbody tr', function() {
                $('#submit_alert').hide()
                id = $(this).attr('id');
                console.log('clicked on row -> id ' + id)
                $.ajax({
                    type: 'GET',
                    url: "{% url 'attd-get-shift' %}",
                    data: {'p_id': id},
                    success: function (response) {
                        show_hidden_div()
                        console.log("dt clicked ajax called")
                        fetch_events(response);
                        guard_id = response.g_id;
                        globalGuard = guard_id;
                    }
                });
            });
            
        }


        var dtopt = {
            "searching": false,
            "paging": false,
            "info": false,
            "initComplete": row_clickable()
        };
        var req = null;
        var sub_req = null;
        var verify_btn = null;
        var dt = datatableview.initialize($('.datatable'), dtopt);
        var table = dt.api();
        $('.datatable').addClass("ui celled table")

        function select_next() {
            $(table.row(table.row('tr.active').index()+1).node()).click();
        }
        
        
        var eventLoaded = false;
        
    }); 

    function salaryButton(){
        console.log("submitting...");
        $.ajax({
            url: "{% url 'attd-submit' %}",
            data: {'g_id': globalGuard },
            success: function(response) {
                console.log(response.success)
                console.log('submitted')
                $('#submit_alert').show()
            }  
        })
    }
</script>
<div class="kt-content kt-grid__item kt-grid__item--fluid" id="kt_content">
    <div class='row'>
        <div class='col'>
            <div class="alert alert-success" style="display:none;" role="alert" id="submit_alert">Salary recorded!</div> 
        </div>
    </div>
    <div class='row'>
        <div class='col'>
            <div class='kt-portlet' id='guard-details' style='display:none;'>
                <div class='kt-portlet__body'>
                    <div class='row'>
                        <div class='col-4'>
                            <div class="kt-profile__main-pic">
                            <!-- change pic later -->
                                <img src="" alt="" id='guard-pic' style='border-radius:50%; max-width:100%; max-height:100%'/>
                            </div>
                            </div>
                        <div class='col-8'>
                        <div class='row'>
                                <h6 class="col-sm text-left font-weight-light" id='guard-id__placeholder'></h6>
                            </div>
                            <div class='row'>
                                <h3 class="col-sm text-left font-weight-light" id='guard-name__placeholder'></h3>
                            </div>
                            <div class='row'>
                                <h6 class="col-sm text-left font-weight-light" id='guard-location'></h6>
                            </div>
                        </div>
                        
                    </div>
                </div>
                <div class='kt-portlet__foot' id='details-footer'>
                    <div class='row d-flex flex-row-reverse'>
                        <!-- <button type='button' class='ml-3 mr-2 btn btn-primary btn-pill' id='next-guard'>Next</button> -->
                        <button type='button' class='btn btn-secondary btn-pill' id='submit-salary' onclick="salaryButton()">Submit Verified Salary</button>
                    </div>
                </div>
            </div>
            <div class='kt-portlet' id='table-area'>
                <div class='kt-portlet__body'>
                    <div class='kt_datatable kt-datatable kt-datatable--default kt-datatable--brand kt-datatable--loaded' id='local_data'>        
                        {{ datatable }}
                    </div>
                </div>
            </div>
        </div>
        <div class='col-6'>
            <div class='kt-portlet' id='calendar-area' style='display:none;'>
                <div class='kt-portlet__body'>
                    <div id='calendar'></div>
                </div>
            </div>
        </div>
        <div class='col'>
            <div class='kt-portlet' id='review-area' style='display:none;'>
                <div class='kt-portlet__body'>
                    <div id='salary-details'>
                        <h6 id='shift-date' class='text-sm-center font-weight-light text-uppercase'>November 2019</h6>
                        <!-- <h2 id='v_pay' class='text-center font-weight-bold text-uppercase'>RM 0</h2> -->
                        <div class='kt-widget-2'>
                            <div class='kt-widget-2__content kt-portlet__space-x' style='padding: 0px !important;'>
                                <div class='row'>
                                    <div class='col'>
                                        <div class="kt-widget-2__item" style="margin-top: 1.4rem !important;">
                                            <div class="kt-widget-2__item-title" id='v_pay' style='font-size: 2rem !important;'>RM 100.00</div>
                                            <div class="kt-widget-2__item-stats">
                                                <div class="kt-widget-2__item-info">
                                                    <h6 class="kt-widget-2__item-text">Released</h6>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class='row'>
                                    <div class='col'>
                                        <div class="kt-widget-2__item"  style="margin-top: 1.4rem !important;">
                                            <div class="kt-widget-2__item-title" id='salary-amount'>RM 100.00</div>
                                            <div class="kt-widget-2__item-stats">
                                                <div class="kt-widget-2__item-info">
                                                    <h6 class="kt-widget-2__item-text">Collected</h6>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class='col'>
                                        <div class="kt-widget-2__item"  style="margin-top: 1.4rem !important;">
                                            <div class="kt-widget-2__item-title" id='u_pay'>RM 100.00</div>
                                            <div class="kt-widget-2__item-stats">
                                                <div class="kt-widget-2__item-info">
                                                    <h6 class="kt-widget-2__item-text">Unverified</h6>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id='shift-details' style='display: none;'>
                                    <div class='row'>
                                        <div class='col'>
                                            <div class="kt-widget-2__item"  style="margin-top: 1.4rem !important;">
                                                <div class="kt-widget-2__item-title">
                                                    <div style='font-size: 2rem !important;'>
                                                        <span id='clocked-start'>07:00</span>-<span id='clocked-end'>19:00</span>
                                                    </div>
                                                </div>
                                                <div class="kt-widget-2__item-stats">
                                                    <div class="kt-widget-2__item-info">
                                                        <h6 class="kt-widget-2__item-text">Clocked Shift • <span id='clocked-duration'></span></h6>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- <div class='row'>
                                        <div class='col'>
                                            <div class="kt-widget-2__item"  style="margin-top: 1.4rem !important;">
                                                <div class="kt-widget-2__item-title">
                                                    <span id='shift-start'>07:00</span>-<span id='shift-end'>19:00</span>
                                                </div>
                                                <div class="kt-widget-2__item-stats">
                                                    <div class="kt-widget-2__item-info">
                                                        <h6 class="kt-widget-2__item-text">Scheduled Shift • <span id='shift-duration'></span></h6>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div> -->
                                    <div class='row'>
                                        <div class='col'>
                                            <div class="kt-widget-2__item"  style="margin-top: 1.4rem !important;">
                                                    <h6 class="material-icons col-sm text-left" style="color:green;" id='fulfilled-icon'>check_circle</h6>
                                                    <div class="kt-widget-2__item-stats">
                                                    <div class="kt-widget-2__item-info">
                                                        <h6 class="kt-widget-2__item-text">Fullfilled</h6>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class='col'>
                                            <div class="kt-widget-2__item"  style="margin-top: 1.4rem !important;">
                                                    <h6 class="material-icons col-sm text-left" style="color:red;" id='verified-icon'>cancel</h6>
                                                    <div class="kt-widget-2__item-stats">
                                                    <div class="kt-widget-2__item-info">
                                                        <h6 class="kt-widget-2__item-text">Verified</h6>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>  
                                </div>                              
                            </div>
                        </div>
                    </div>
                </div>
                <div class='kt-portlet__foot' style='display:none' id='salary-footer'>
                    <div class='row d-flex flex-row-reverse'>
                        <button type='button' class='ml-3 mr-2 btn btn-success btn-pill' id='shift-verify'>Approve Entry</button>
                        <!-- <button type='button' class='ml-3 mr-2 btn btn-primary btn-pill' id='next-guard'>Next</button>
                        <button type='button' class='btn btn-secondary btn-pill' id='prev-guard'>Previous</button> -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}